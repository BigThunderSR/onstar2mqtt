name: Sync Patchright Version

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - 'package.json'
  workflow_dispatch:

jobs:
  sync-patchright-pr:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && (github.actor == 'dependabot[bot]' || github.actor == 'renovate[bot]')
    
    steps:
      - name: Check if onstarjs2 changed
        id: check-onstarjs2
        uses: actions/github-script@v8
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });
            
            const packageJsonFile = files.find(f => f.filename === 'package.json');
            if (!packageJsonFile || !packageJsonFile.patch) {
              console.log('No package.json changes found');
              return false;
            }
            
            const hasOnstarjs2Change = packageJsonFile.patch.includes('onstarjs2');
            console.log('onstarjs2 changed:', hasOnstarjs2Change);
            return hasOnstarjs2Change;

      - name: Checkout code
        if: steps.check-onstarjs2.outputs.result == 'true'
        uses: actions/checkout@v6
        with:
          ref: ${{ github.head_ref }}
          token: ${{ secrets.PAT_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        if: steps.check-onstarjs2.outputs.result == 'true'
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Run sync-patchright
        if: steps.check-onstarjs2.outputs.result == 'true'
        run: npm run sync-patchright

      - name: Update package-lock.json
        if: steps.check-onstarjs2.outputs.result == 'true'
        run: npm install

      - name: Check for changes
        if: steps.check-onstarjs2.outputs.result == 'true'
        id: git-check
        run: |
          git diff --exit-code package.json package-lock.json || echo "changed=true" >> $GITHUB_OUTPUT

      - name: Stage changes
        if: steps.check-onstarjs2.outputs.result == 'true' && steps.git-check.outputs.changed == 'true'
        run: git add package.json package-lock.json

      - name: Commit and push changes
        if: steps.check-onstarjs2.outputs.result == 'true' && steps.git-check.outputs.changed == 'true'
        uses: planetscale/ghcommit-action@v0.2.19
        with:
          commit_message: "chore: sync patchright version with onstarjs2"
          repo: ${{ github.repository }}
          branch: ${{ github.head_ref }}
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}

  sync-patchright-manual:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          ref: main
          token: ${{ secrets.PAT_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Run sync-patchright
        run: npm run sync-patchright

      - name: Update package-lock.json
        run: npm install

      - name: Check for changes
        id: git-check
        run: |
          git diff --exit-code package.json package-lock.json || echo "changed=true" >> $GITHUB_OUTPUT

      - name: Create branch and commit
        if: steps.git-check.outputs.changed == 'true'
        id: create-branch
        run: |
          BRANCH_NAME="chore/sync-patchright-$(date +%Y%m%d-%H%M%S)"
          echo "branch=$BRANCH_NAME" >> $GITHUB_OUTPUT
          git checkout -b "$BRANCH_NAME"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add package.json package-lock.json
          git commit -m "chore: sync patchright version with onstarjs2"
          git push origin "$BRANCH_NAME"

      - name: Create Pull Request
        if: steps.git-check.outputs.changed == 'true'
        run: |
          gh pr create --title "chore: sync patchright version with onstarjs2" \
            --body "This PR was automatically created by the manual sync-patchright workflow to update the patchright override to match the version expected by onstarjs2." \
            --base main \
            --head "${{ steps.create-branch.outputs.branch }}" \
            --label "patchright-sync" \
            --label "onstarjs2-dependency" \
            --label "dependencies" \
            --label "javascript"
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}

      - name: No changes needed
        if: steps.git-check.outputs.changed != 'true'
        run: echo "Patchright is already in sync with onstarjs2. No changes needed."
